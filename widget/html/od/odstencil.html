<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>外喷标</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/style.css" />
    <link rel="stylesheet" type="text/css" href="../../css/mobiscroll.custom-3.0.0-beta6.min.css" />
</head>

<body>
    <header class="form-nav" id="header">
        <div class="arrow" tapmode onclick="closeWindow();"></div>
        <span class="nav-pipeno i18n1" name="odstencil" style="display:inline-block;margin-left:-43px;line-height:43px;"></span>
    </header>
    <div class="form-content" id="content">
      <div class="form-item">
          <table class="pipeinfo-table">
              <thead>
                  <tr>
                      <th class="i18n1" name="pipebasicinfo" colspan="4" style="text-align:center;">钢管基础信息</th>
                  </tr>
              </thead>
              <tr>
                  <td class="i18n1" name="pipeno"></td>
                  <td class="pipe_no"></td>
                  <td class="i18n1" name="statusname"></td>
                  <td class="status_name"></td>
              </tr>
              <tr>
                  <td class="i18n1" name="od"></td>
                  <td class="od"></td>
                  <td class="i18n1" name="wt"></td>
                  <td class="wt"></td>
              </tr>
              <tr>
                  <td class="i18n1" name="millno"></td>
                  <td class="millno"></td>
              </tr>
          </table>
      </div>
      <div class="form-item">
          <input type="hidden" value="0" class="id"/>
          <!-- <div class="form-item-lbl">
              <label class="i18n1 air_temp_lbl" name="airtemp"></label>
          </div>
          <div class="form-item-val">
              <input type="text" data-number=true data-required=false  class="mob-air-temperature air_temp" name="air_temp" value="" />
          </div> -->
      </div>

        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 center_line_color_lbl" name="centerlinecolor"></label>
            </div>
            <div class="form-item-val">
                <select id="center_line_color" name="center_line_color">
                <option value="NONE">无</option>
                    <option value="RED">红色</option>
                    <option value="YELLOW">黄色</option>
                    <option value="WHITE">白色</option>
                    <option value="GREEN">绿色</option>
                    <option value="BLUE">蓝色</option>
                    <option value="BLACK">黑色</option>
                   </select>
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 pipe_end_color_lbl" name="pipeendcolor"></label>
            </div>
            <div class="form-item-val">
                <select id="pipe_end_color" name="pipe_end_color">
                         <option value="NONE">无</option>
                         <option value="RED">红色</option>
                         <option value="YELLOW">黄色</option>
                         <option value="WHITE">白色</option>
                         <option value="GREEN">绿色</option>
                         <option value="BLUE">蓝色</option>
                         <option value="BLACK">黑色</option>
                     </select>
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 stencil_content_lbl" name="stencilcontent"></label>
            </div>
            <div class="form-item-val">
                 <textarea  type="text" id="stencil_content" data-number=false data-required=false  maxlength="200" name="stencil_content"></textarea>
            </div>
        </div>

        <div class="form-item">
            <div class="form-item-lbl result_lbl">
                <label class="i18n1" name="result"></label>
            </div>
            <div class="form-item-val">
                <select id="result" name="result">
                      <option value="1">合格,进入外防终检工序</option>
                        <option value="0">不合格,重新喷标</option>
                      <option value="10">待定</option>
                  </select>
            </div>
        </div>
        <div class="form-item">
            <div class="imgBox"></div>
            <!-- <div style=""></div> -->
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1" name="selectpicture"></label>
            </div>
            <div class="form-item-val">
                <button class="i18n1 form-pictures" name="selectpicture"></button>
            </div>

        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 remark_lbl" name="remark"></label>
            </div>
            <div class="form-item-val">
                <textarea id="remark" name="remark"></textarea>
            </div>
        </div>


    </div>
    <footer class="form-footer" id=footer>
        <div id="foot-container" style="width:100%;height:43px;display:flex;justify-content:center;align-items:center;" class="foot-container">
            <div class="i18n1 form-process-button" name="submit" onclick="submitForm()">提交</div>
        </div>
    </footer>
</body>

</html>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script src="../../script/jquery.i18n.properties-1.0.9.js" type="text/javascript"></script>
<script src="../../script/language.js" type="text/javascript"></script>
<script src="../../script/mobiscroll.custom-3.0.0-beta6.min.js" type="text/javascript"></script>
<script type="text/javascript">
var g_pipeno;
var g_employeeno, g_millno;
//检验频次Map
var inspectFreqMap = [];
//OD接收标准
var ODacceptCriteriaMap;
//UILoading 的id
var g_loadingID = 0;
    apiready = function() {
        DoLoadingPicture();
        var data = api.pageParam;
        g_pipeno = data.pipe_no;
        fnSettingHeader();
        hlLanguage("../../i18n/");
        RequestAllProcessInfoByPipeNo(g_pipeno);
        //请求RequestMySesssion
        //RequestMySesssion();
    }

    //继续方法
    // function Go(employeeno, millno) {
    //     //初始化表单业务逻辑
    //     g_employeeno = employeeno;
    //     g_millno = millno;
    //     if (g_pipeno != undefined&&g_millno!=undefined) {
    //         RequestODAcceptCriteria(g_pipeno,g_millno);
    //         //getPipeBasicInfoHeader(g_pipeno, g_millno);
    //     }
    //
    //     setSelectPictures();
    //     hlLanguage("../../i18n/");
    //     ClearLoadingPicture();
    // }
    //
    // //撤退方法
    // function Reverse(msg) {
    //   ClearLoadingPicture();
    //     alert(msg);
    //     setTimeout("closeWindow()", 1000);
    // }

    //得到检验频次信息成功
    // function GetInspectFreqOK(data) {
    //     inspectFreqMap = data;
    //     api.alert({
    //         msg: JSON.stringify(inspectFreqMap)
    //     });
    // }
    //
    // //得到检验频次信息失败
    // function GetInspectFreqFail() {
    //     api.alert({
    //         msg: 'GetInspectFreqFail'
    //     });
    // }

    //得到钢管数据汇总成功
    function GetAllProcessInfoByPipeNoOK(data) {
        ClearLoadingPicture();
        g_employeeno = data.employeeno;
        g_millno=data.millno;
        if(data.pipeinfo.status!="od4"){
            closeWindow();
        }
        ///setTimeout(function() {
            //执行刷新
            initCriteria(data.odcriteria);
            initCriteria(data.pbcriteria);
            initInspectionFreq(data.inspectfreq);
            initPipeBasicHeader(data.pipeinfo, data.millno);
        //}, 200);
          setControls();
          setSelectPictures();

        getPendingRecordInfo("OdStencilOperation", g_pipeno);
        if(data&&$('#stencil_content').val()==""){
          var str = data.odcriteria.stencil_content;
          $('#stencil_content').val(str);
        }

        // api.alert({
        //     msg: JSON.stringify(ODacceptCriteriaMap)
        // });
    }
    //得到外防接收标准失败
    function GetAllProcessInfoByPipeNoFail() {
      ClearLoadingPicture();
        api.alert({
            msg: 'GetAllProcessInfoByPipeNoFail'
        });
    }


    function getPendingRecordInfoOK(data) {
        if (data != undefined) {
            $('.id').val(data.id);
            $('#center_line_color').val(data.center_line_color);
            $('#pipe_end_color').val(data.pipe_end_color);
            if(data.stencil_content!=undefined&&data.stencil_content!=""){
                $('#stencil_content').val(data.stencil_content);
            }
            $('#result').val(data.result);
            var imgUrl = data.upload_files;
            if (imgUrl.length > 0) {
                var imgArr = imgUrl.split(';');
                var s = 'http://' + serverIP + '/upload/pictures/';
                for (var i = 0; i < imgArr.length; i++) {
                    if (imgArr[i] != undefined && imgArr[i].length > 0)
                        $('.imgBox').append(pictureTemplate(imgArr[i], s + imgArr[i]));
                }
            }
            $('#remark').val(data.remark);
        }
    }

    function getPendingRecordInfoFail() {

    }

    function submitForm() {
        if (initFormNumber()) {
            var s = 'http://' + serverIP + '/OdStencilOperation/saveOdStencilProcess.action';
            var imgUrl = "";
            $('.imgBox  .temp-container img').each(function() {
              var temp = $(this).attr("data-url");
              if(temp!=undefined){
                  imgUrl += (temp + ";");
              }
            });
            alert(imgUrl);
            api.ajax({
                url: s,
                method: 'post',
                timeout: 30,
                dataType: 'json',
                data: {
                    values: {
                        id:$('.id').val(),
                        pipe_no: g_pipeno,
                        mill_no: g_millno,
                        operator_no: g_employeeno,
                        center_line_color:$('#center_line_color').val(),
                        pipe_end_color:$('#pipe_end_color').val(),
                        stencil_content:$('#stencil_content').val(),
                        result:$('#result').val(),
                        upload_files: imgUrl,
                        remark: $('#remark').val(),
                    }
                }
            }, function(ret, err) { //alert(ret);
                if (ret) {
                    api.alert({
                        msg: ret.message
                    });
                    if (ret.success) {
                        closeWindow();
                    }
                } else {
                    api.alert({
                        msg: JSON.stringify(err)
                    });
                }
            });
        }
    }


</script>
