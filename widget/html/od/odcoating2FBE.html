<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>外涂2FBE</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/style.css" />
    <link rel="stylesheet" type="text/css" href="../../css/mobiscroll.custom-3.0.0-beta6.min.css" />
</head>

<body>
    <header class="form-nav" id="header">
        <div class="arrow" tapmode onclick="closeWindow();"></div>
        <span class="nav-pipeno i18n1" name="odcoating2FBE" style="display:inline-block;margin-left:-43px;line-height:43px;"></span>
    </header>
    <div class="form-content" id="content">
      <div class="form-item">
          <div class="form-item-lbl">
              <label class="i18n1" name="selectcoatingpipe"></label>
          </div>
          <div class="form-item-val">
              <select id="selectcoatingpipe" name="select-coating-pipe" onchange="loadPage()">

              </select>
          </div>
      </div>
      <div class="form-item">
          <table class="pipeinfo-table">
              <thead>
                  <tr>
                      <th class="i18n1" name="pipebasicinfo" colspan="4" style="text-align:center;">钢管基础信息</th>
                  </tr>
              </thead>
              <tr>
                  <td class="i18n1" name="pipeno"></td>
                  <td class="pipe_no"></td>
                  <td class="i18n1" name="statusname"></td>
                  <td class="status_name"></td>
              </tr>
              <tr>
                  <td class="i18n1" name="od"></td>
                  <td class="od"></td>
                  <td class="i18n1" name="wt"></td>
                  <td class="wt"></td>
              </tr>
              <tr>
                  <td class="i18n1" name="millno"></td>
                  <td class="millno"></td>
              </tr>
          </table>
      </div>

      <div class="form-item">
          <input type="hidden" value="0" class="id" />
      </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 coating_line_speed_lbl" name="coatinglinespeed"></label>
            </div>
            <div class="form-item-val">
                <input data-number=true data-required=false type="text" class="mob-line-speed coating_line_speed" name="coating_line_speed" value="" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 application_temp_lbl" name="applicationtemp"></label>
            </div>
            <div class="form-item-val">
                <input type="text" data-number=true data-required=false  class="mob-application-temp application_temp" name="application_temp" value="" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1" name="basecoatused"></label>
            </div>
            <div class="form-item-val">
                <input type="text" name="base_coat_used" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1" name="basecoatlotno"></label>
            </div>
            <div class="form-item-val">
                <input type="text" name="base_coat_lot_no" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1" name="topcoatused"></label>
            </div>
            <div class="form-item-val">
                <input type="text" name="top_coat_used" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1" name="topcoatlotno"></label>
            </div>
            <div class="form-item-val">
                <input type="text" name="top_coat_lot_no" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 base_coat_gun_count_lbl" name="basecoatguncount"></label>
            </div>
            <div class="form-item-val">
                <input type="text" data-number=true data-required=false class="mob-base-coat-gun-count base_coat_gun_count" name="base_coat_gun_count" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 top_coat_gun_count_lbl" name="topcoatguncount"></label>
            </div>
            <div class="form-item-val">
                <input type="text" data-number=true data-required=false class="mob-top-coat-gun-count top_coat_gun_count" name="top_coat_gun_count" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 to_first_touch_duration_lbl" name="tofirsttouchduration"></label>
            </div>
            <div class="form-item-val">
                <input type="text" data-number=true data-required=false class="to_first_touch_duration" name="to_first_touch_duration" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 to_quench_duration_lbl" name="toquenchduration"></label>
            </div>
            <div class="form-item-val">
                <input type="text" data-number=true data-required=false class="to_quench_duration" name="to_quench_duration" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 air_pressure_lbl" name="airpressure"></label>
            </div>
            <div class="form-item-val">
                <input type="number" data-number=true data-required=false class="air_pressure" name="air_pressure" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 coating_voltage_lbl" name="coatingvoltage"></label>
            </div>
            <div class="form-item-val">
                <input type="text" data-number=true data-required=false class="coating_voltage" name="coating_voltage" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 gun_distance_lbl" name="gundistance"></label>
            </div>
            <div class="form-item-val">
                <input type="text" data-number=true data-required=false class="gun_distance" name="gun_distance" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 spray_speed_lbl" name="sprayspeed"></label>
            </div>
            <div class="form-item-val">
                <input type="text" data-number=true data-required=false class="spray_speed" name="spray_speed" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 application_voltage_lbl" name="applicationvoltage"></label>
            </div>
            <div class="form-item-val">
                <input type="text" data-number=true data-required=false class="application_voltage" name="application_voltage" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1" name="result"></label>
            </div>
            <div class="form-item-val">
                <select id="cc" name="result">
                      <option value="1">合格,进入外涂敷检验工序</option>
                      <option value="0">不合格,进入外喷砂工序</option>
                      <option value="10">待定</option>
                  </select>
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1" name="remark"></label>
            </div>
            <div class="form-item-val">
                <textarea name="remark"></textarea>
            </div>
        </div>
        <div class="form-item">
            <div class="imgBox"></div>
            <!-- <div style=""></div> -->
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1" name="selectpicture"></label>
            </div>
            <div class="form-item-val">
                <button class="i18n1 form-pictures" name="selectpicture"></button>
            </div>

        </div>

    </div>
    <footer class="form-footer" id=footer>
        <div id="foot-container" style="width:100%;height:43px;display:flex;justify-content:center;align-items:center;" class="foot-container">
            <div class="i18n1 form-process-button" name="submit" onclick="">提交</div>
        </div>
    </footer>
</body>

</html>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script src="../../script/jquery.i18n.properties-1.0.9.js" type="text/javascript"></script>
<script src="../../script/language.js" type="text/javascript"></script>
<script src="../../script/mobiscroll.custom-3.0.0-beta6.min.js" type="text/javascript"></script>
<script type="text/javascript">
    var g_pipeno;
    var g_employeeno, g_millno;
    //检验频次Map
    var inspectFreqMap = [];
    //OD接收标准
    var ODacceptCriteriaMap;
    //UILoading 的id
    var g_loadingID = 0;
    apiready = function() {
            var data = api.pageParam;
            g_pipeno = data.pipe_no;
            DoLoadingPicture();
            fnSettingHeader();
            hlLanguage("../../i18n/");
            //获取后十条涂层记录
             loadPage();
            //选择控件判断是否合格事件
            validateSelect();
        }
    function GetAllProcessInfoByPipeNoOK(data) {
        ClearLoadingPicture();
        //alert(JSON.stringify(data));
        g_employeeno = data.employeeno;
        g_millno = data.millno;
        if (data.pipeinfo.status != "od1") {
            closeWindow();
        }
        initCriteria(data.odcriteria);
        initCriteria(data.pbcriteria);
        initInspectionFreq(data.inspectfreq);
        initPipeBasicHeader(data.pipeinfo, data.millno);
        setControls();
        setSelectPictures();
        getPendingRecordInfo("OdCoatOperation", g_pipeno);
        //
    }
    //得到外防接收标准失败
    function GetAllProcessInfoByPipeNoFail() {
        ClearLoadingPicture();
        api.alert({
            msg: 'GetAllProcessInfoByPipeNoFail'
        });
        closeWindow();
    }
    //获取待定数据成功事件
    function getPendingRecordInfoOK(data) {
        if (data != undefined) {
            $('.id').val(data.id);
            if(data.remark!=undefined&&data.remark!="INIT"){
              if(data.coating_line_speed!=-99)
                 $('input[name="coating_line_speed"]').val(data.coating_line_speed);
              if(data.application_temp!=-99)
                 $('input[name="application_temp"]').val(data.application_temp);
              $('input[name="base_coat_used"]').val(data.base_coat_used);
              $('input[name="base_coat_lot_no"]').val(data.base_coat_lot_no);
              $('input[name="top_coat_used"]').val(data.top_coat_used);
              $('input[name="top_coat_lot_no"]').val(data.top_coat_lot_no);
              if(data.base_coat_gun_count!=-99)
                 $('input[name="base_coat_gun_count"]').val(data.base_coat_gun_count);
              if(data.top_coat_gun_count!=-99)
                 $('input[name="top_coat_gun_count"]').val(data.top_coat_gun_count);
              if(data.application_temp!=-99)
                 $('input[name="application_temp"]').val(data.application_temp);
              if(data.to_first_touch_duration!=-99)
                 $('input[name="to_first_touch_duration"]').val(data.to_first_touch_duration);
              if(data.to_quench_duration!=-99)
                 $('input[name="to_quench_duration"]').val(data.to_quench_duration);
              if(data.air_pressure!=-99)
                 $('input[name="air_pressure"]').val(data.air_pressure);
              if(data.coating_voltage!=-99)
                $('input[name="coating_voltage"]').val(data.coating_voltage);
              if(data.gun_distance!=-99)
                $('input[name="gun_distance"]').val(data.gun_distance);
              if(data.spray_speed!=-99)
                $('input[name="spray_speed"]').val();
              if(data.application_voltage!=-99)
                $('input[name="application_voltage"]').val(data.application_voltage);
              $('#result').val(data.result);
              var imgUrl = data.upload_files;
              if (imgUrl.length > 0) {
                  var imgArr = imgUrl.split(';');
                  var s = 'http://' + serverIP + '/upload/pictures/';
                  for (var i = 0; i < imgArr.length; i++) {
                      if (imgArr[i] != undefined && imgArr[i].length > 0)
                          $('.imgBox').append(pictureTemplate(imgArr[i], s + imgArr[i]));
                  }
              }
              $('#remark').val(data.remark);
            }else{
                //此记录为计算机生成
                RequestLastAcceptedRecordBeforePipeNo(data.pipe_no,"OdCoatOperation");
            }
        }
    }
    //
    function   RequestLastAcceptedRecordBeforePipeNoOK(data){
          if(data!=undefined){
              $('.id').val(data.id);
              if(data.coating_line_speed!=-99)
                 $('input[name="coating_line_speed"]').val(data.coating_line_speed);
              if(data.application_temp!=-99)
                 $('input[name="application_temp"]').val(data.application_temp);
              $('input[name="base_coat_used"]').val(data.base_coat_used);
              $('input[name="base_coat_lot_no"]').val(data.base_coat_lot_no);
              $('input[name="top_coat_used"]').val(data.top_coat_used);
              $('input[name="top_coat_lot_no"]').val(data.top_coat_lot_no);
              if(data.base_coat_gun_count!=-99)
                 $('input[name="base_coat_gun_count"]').val(data.base_coat_gun_count);
              if(data.top_coat_gun_count!=-99)
                 $('input[name="top_coat_gun_count"]').val(data.top_coat_gun_count);
              if(data.application_temp!=-99)
                 $('input[name="application_temp"]').val(data.application_temp);
              if(data.to_first_touch_duration!=-99)
                 $('input[name="to_first_touch_duration"]').val(data.to_first_touch_duration);
              if(data.to_quench_duration!=-99)
                 $('input[name="to_quench_duration"]').val(data.to_quench_duration);
              if(data.air_pressure!=-99)
                 $('input[name="air_pressure"]').val(data.air_pressure);
              if(data.coating_voltage!=-99)
                $('input[name="coating_voltage"]').val(data.coating_voltage);
              if(data.gun_distance!=-99)
                $('input[name="gun_distance"]').val(data.gun_distance);
              if(data.spray_speed!=-99)
                $('input[name="spray_speed"]').val();
              if(data.application_voltage!=-99)
                $('input[name="application_voltage"]').val(data.application_voltage);
              $('#result').val(data.result);
              var imgUrl = data.upload_files;
              if (imgUrl.length > 0) {
                  var imgArr = imgUrl.split(';');
                  var s = 'http://' + serverIP + '/upload/pictures/';
                  for (var i = 0; i < imgArr.length; i++) {
                      if (imgArr[i] != undefined && imgArr[i].length > 0)
                          $('.imgBox').append(pictureTemplate(imgArr[i], s + imgArr[i]));
                  }
              }
              $('#remark').val(data.remark);
    }
    //
    function RequestLastAcceptedRecordBeforePipeNoFail(){

    }
    //获取待定数据失败事件
    function getPendingRecordInfoFail() {

    }
    //表单提交
    function submitForm() {
        if (initFormNumber()) {
            var s = 'http://' + serverIP + '/OdCoatOperation/saveOdCoatingProcess.action';
            var imgUrl = "";
            $('.imgBox  .temp-container img').each(function() {
                var temp = $(this).attr("data-url");
                if (temp != undefined) {
                    imgUrl += (temp + ";");
                }
            });
            api.ajax({
                url: s,
                method: 'post',
                timeout: 30,
                dataType: 'json',
                data: {
                    values: {
                        id: $('.id').val(),
                        pipe_no: g_pipeno,
                        mill_no: g_millno,
                        operator_no: g_employeeno,
                        coating_line_speed: $('input[name="coating_line_speed"]').val(),
                        application_temp:  $('input[name="application_temp"]').val(),
                        base_coat_used:  $('input[name="base_coat_used"]').val(),
                        base_coat_lot_no:  $('input[name="base_coat_lot_no"]').val(),
                        top_coat_used: $('input[name="top_coat_used"]').val(),
                        top_coat_lot_no: $('input[name="top_coat_lot_no"]').val(),
                        base_coat_gun_count: $('input[name="base_coat_gun_count"]').val(),
                        top_coat_gun_count: $('input[name="top_coat_gun_count"]').val(),
                        application_temp: $('input[name="application_temp"]').val(),
                        to_first_touch_duration: $('input[name="to_first_touch_duration"]').val(),
                        to_quench_duration: $('input[name="to_quench_duration"]').val(),
                        air_pressure: $('input[name="air_pressure"]').val(),
                        coating_voltage: $('input[name="coating_voltage"]').val(),
                        gun_distance: $('input[name="gun_distance"]').val(),
                        spray_speed: $('input[name="spray_speed"]').val(),
                        application_voltage:$('input[name="application_voltage"]').val(),
                        result: $('#result').val(),
                        upload_files: imgUrl,
                        remark: $('#remark').val(),
                    }
                }
            }, function(ret, err) { //alert(ret);
                if (ret) {
                    api.alert({
                        msg: ret.message
                    });
                    if (ret.success) {
                        closeWindow();
                    }
                } else {
                    api.alert({
                        msg: JSON.stringify(err)
                    });
                }
            });
        }
    }
    //得到钢管后10根涂层记录管号，并且记录为待定状态 10,回调
    function RequestNextTenPipesBeforePipeNoEventOK(data){
        if(data!=undefined){
            $('#selectcoatingpipe').empty();
            for (var i = 0; i < data.length; i++) {
               var pipe_no=data[i].pipe_no;
               $('#selectcoatingpipe').append("<option value="+pipe_no+">"+(i+1)+":"+pipe_no+"</option>");
            }
        }
    }
    function RequestNextTenPipesBeforePipeNoEventFail(){

    }
    function loadPage(){
      RequestNextTenPipesBeforePipeNo(g_pipeno,"OdCoatOperation");
      RequestAllProcessInfoByPipeNo(g_pipeno);
    }
</script>
