<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>外喷砂检验</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/style.css" />
    <link rel="stylesheet" type="text/css" href="../../css/mobiscroll.custom-3.0.0-beta6.min.css" />
</head>

<body>
    <header class="form-nav" id="header">
        <div class="arrow" tapmode onclick="closeWindow();"></div>
        <span class="nav-pipeno i18n1" name="odblastinspection" style="display:inline-block;margin-left:-43px;line-height:43px;"></span>
    </header>
    <div class="form-content" id="content">

        <div class="form-item">
            <table class="pipeinfo-table">
                <thead>
                    <tr>
                        <th class="i18n1" name="pipebasicinfo" colspan="4" style="text-align:center;">钢管基础信息</th>
                    </tr>
                </thead>
                <tr>
                    <td class="i18n1" name="pipeno"></td>
                    <td class="pipe_no"></td>
                    <td class="i18n1" name="statusname"></td>
                    <td class="status_name"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="od"></td>
                    <td class="od"></td>
                    <td class="i18n1" name="wt"></td>
                    <td class="wt"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="millno"></td>
                    <td class="millno"></td>
                </tr>
            </table>
        </div>
        <div class="form-item">
            <input type="hidden" value="0" class="id" />
            <!-- <div class="form-item-lbl">
                <label class="i18n1 air_temp_lbl" name="airtemp"></label>
            </div>
            <div class="form-item-val">
                <input type="text" data-number=true data-required=false  class="mob-air-temperature air_temp" name="air_temp" value="" />
            </div> -->
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 air_temp_lbl" name="airtemp"></label>
            </div>
            <div class="form-item-val">
                <input type="text" data-number=true data-required=false class="mob-air-temperature air_temp" name="air_temp" value="" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 relative_humidity_lbl" name="relativehumidity"></label>
            </div>
            <div class="form-item-val">
                <input type="text" data-number=true data-required=false class="mob-humidity relative_humidity" name="relative_humidity" value="" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 dew_point_lbl" name="dewpoint"></label>
            </div>
            <div class="form-item-val">
                <input type="text" data-number=true data-required=false onchange="setDeltaTemp()" class="mob-air-temperature dew_point" name="dew_point" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 pipe_temp_after_blast_lbl" name="pipetemp"></label>
            </div>
            <div class="form-item-val">
                <input type="text" data-number=true data-required=false onchange="setDeltaTemp()" class="mob-pipe-temperature pipe_temp_after_blast" name="pipe_temp_after_blast" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 temp_above_dew_point_lbl" name="deltatemp"></label>
            </div>
            <div class="form-item-val">
                <input type="text" readonly=true data-number=true data-required=false class="temp_above_dew_point delta_temp" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 od_profile_lbl" name="profile"></label>
            </div>
            <div class="form-item-val">
                <input type="text" data-number=true data-required=false class="mob-profile od_profile" name="profile" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 salt_contamination_after_blasting_lbl" name="saltcontaminationafterblasting"></label>
            </div>
            <div class="form-item-val">
                <input type="text" data-number=true data-required=false class="mob-salt-contamination salt_contamination_after_blasting" name="salt_contamination_after_blasting" />
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 blast_finish_sa25_lbl" name="blastfinishsa25"></label>
            </div>
            <div class="form-item-val">
                <select id="bfs" data-required=false class="validate-select blast_finish_sa25"  name="blast_finish_sa25">
                         <option value="2.0">Sa2.0</option>
                         <option value="2.5">Sa2.5</option>
                         <option value="3.0">Sa3.0</option>
                         <option value="" selected="selected">未测</option>
                     </select>
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 surface_dust_rating_lbl" name="surfacedustrating"></label>
            </div>
            <div class="form-item-val">
                <select id="sdr" data-required=false class="validate-select surface_dust_rating" data-required=false name="surface_dust_rating">
                         <option value="-99" selected="selected">未测</option>
                         <option value="1" >1级</option>
                         <option value="2">2级</option>
                         <option value="3">3级</option>
                         <option value="4">4级</option>
                         <option value="5">5级</option>
                     </select>
            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 surface_condition_lbl" name="surfacecondition"></label>
            </div>
            <div class="form-item-val">
                <button data-type="steel" class="i18n1 form-steel-condition form-condition" name="select"></button>
            </div>
            <div class="form-steel-select-val">

            </div>
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1 oil_water_in_air_compressor_lbl" name="oilwaterinaircompressor"></label>
            </div>
            <div class="form-item-val">
                     <select id="oilwater" data-required=false name="oil_water_in_air_compressor">
                         <option value="0" selected="selected">否</option>
                         <option value="1">是</option>
                     </select>
            </div>
        </div>
        <!-- <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1" name="elapsedtime"></label>
            </div>
            <div class="form-item-val">
                <input type="number" name="elapsed_time" />
            </div>
        </div> -->
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1" name="result"></label>
            </div>
            <div class="form-item-val">
                <select id="result" name="result">
                        <option value="1">合格,进入外涂敷工序</option>
                        <option value="0">不合格,重新打砂处理</option>
                        <option value="10" selected="selected">待定</option>
                        <option value="3">隔离，进入修磨或切割工序</option>
                    </select>
            </div>
        </div>
        <div class="form-item">
            <div class="imgBox"></div>
            <!-- <div style=""></div> -->
        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1" name="selectpicture"></label>
            </div>
            <div class="form-item-val">
                <button class="i18n1 form-pictures" name="selectpicture"></button>
            </div>

        </div>
        <div class="form-item">
            <div class="form-item-lbl">
                <label class="i18n1" name="remark"></label>
            </div>
            <div class="form-item-val">
                <textarea id="remark" name="remark"></textarea>
            </div>
        </div>


    </div>
    <footer class="form-footer" id=footer>
        <div id="foot-container" style="width:100%;height:43px;display:flex;justify-content:center;align-items:center;" class="foot-container">
            <div class="i18n1 form-process-button" name="submit" onclick="submitForm()">提交</div>
        </div>
    </footer>
</body>

</html>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script src="../../script/jquery.i18n.properties-1.0.9.js" type="text/javascript"></script>
<script src="../../script/language.js" type="text/javascript"></script>
<script src="../../script/mobiscroll.custom-3.0.0-beta6.min.js" type="text/javascript"></script>
<script type="text/javascript">
    var g_pipeno;
    var g_employeeno, g_millno;
    //UILoading 的id
    var g_loadingID = 0;
    apiready = function() {
            var data = api.pageParam;
            g_pipeno = data.pipe_no;
            DoLoadingPicture();
            fnSettingHeader();
            hlLanguage("../../i18n/");
            RequestAllProcessInfoByPipeNo(g_pipeno);

        }
        //继续方法
        // function Go(employeeno, millno) {
        //
        //     g_employeeno = employeeno;
        //     g_millno = millno;
        //     //初始化表单业务逻辑
        //     if (g_pipeno != undefined&&g_millno!=undefined) {
        //         RequestODAcceptCriteria(g_pipeno,g_millno);
        //         //getPipeBasicInfoHeader(g_pipeno, g_millno);
        //     }
        //     setAllDefectInfo("steel");
        //     setSelectPictures();
        //     hlLanguage("../../i18n/");
        //     ClearLoadingPicture();
        // }
        // //撤退方法
        // function Reverse(msg) {
        //     //ClearLoadingPicture();
        //     alert(msg);
        //
        //     setTimeout("closeWindow()", 1000);
        // }



    //得到检验频次信息成功
    // function GetInspectFreqOK(data) {
    //     inspectFreqMap = data;
    //     api.alert({
    //         msg: JSON.stringify(inspectFreqMap)
    //     });
    // }
    //
    // //得到检验频次信息失败
    // function GetInspectFreqFail() {
    //     api.alert({
    //         msg: 'GetInspectFreqFail'
    //     });
    // }

    function GetAllProcessInfoByPipeNoOK(data) {
        ClearLoadingPicture();
        g_employeeno = data.employeeno;
        g_millno = data.millno;
        if (data.pipeinfo.status != "od1") {
            closeWindow();
        }
        setAllDefectInfo("steel");
        initCriteria(data.odcriteria);
        initCriteria(data.pbcriteria);
        initInspectionFreq(data.inspectfreq);
        initPipeBasicHeader(data.pipeinfo, data.millno);
        setControls();
        setSelectPictures();
        getPendingRecordInfo("OdBlastInspectionOperation", g_pipeno);
    }
    //得到外防接收标准失败
    function GetAllProcessInfoByPipeNoFail(message) {
        ClearLoadingPicture();
        api.alert({
            msg: message
        });
        closeWindow();
    }


    //得到外防接收标准成功
    // function GetODAcceptCriteriaOK(data) {
    //     ODacceptCriteriaMap = data.criteria;
    //     inspectFreqMap = data.inspectfreq;
    //     setControls();
    //     getPendingRecordInfo("OdBlastInspectionOperation", g_pipeno);
    //     hlLanguage("../../i18n/");
    //     // api.alert({
    //     //     msg: JSON.stringify(ODacceptCriteriaMap)
    //     // });
    // }
    // //得到外防接收标准失败
    // function GetODAcceptCriteriaFail() {
    //     api.alert({
    //         msg: 'GetODAcceptCriteriaFail'
    //     });
    // }

    function getPendingRecordInfoOK(data) {
        if (data != undefined) {
            $('.id').val(data.id);
            if (data.air_temp != -99) {
                $('input[name="air_temp"]').val(data.air_temp);
            }
            $('#bfs').val(data.blast_finish_sa25);
            $('#sdr').val(data.surface_dust_rating);
            if (data.relative_humidity != -99) {
                $('input[name="relative_humidity"]').val(data.relative_humidity);
            }
            if (data.dew_point != -99) {
                $('input[name="dew_point"]').val(data.dew_point);
            }
            if (data.pipe_temp != -99) {
                $('input[name="pipe_temp_after_blast"]').val(data.pipe_temp);
            }
            if (data.profile != -99) {
                $('input[name="profile"]').val(data.profile);
            }

            $('.form-steel-select-val').text(data.surface_condition);
            $('#oilwater').val(data.oil_water_in_air_compressor);
            //  $('input[name="elapsed_time"]').val(data.elapsed_time);
            if (data.salt_contamination_after_blasting != -99) {
                $('input[name="salt_contamination_after_blasting"]').val(data.salt_contamination_after_blasting);
            }
            $('#result').val(data.result);

            var imgUrl = data.upload_files;
            if (imgUrl.length > 0) {
                var imgArr = imgUrl.split(';');
                var s = 'http://' + serverIP + '/upload/pictures/';
                for (var i = 0; i < imgArr.length; i++) {
                    if (imgArr[i] != undefined && imgArr[i].length > 0)
                        $('.imgBox').append(pictureTemplate(imgArr[i], s + imgArr[i]));
                }
            }

            $('#remark').val(data.remark);
            setDeltaTemp(); //设置露点温度差
            validateAllValue();
        }
    }

    function getPendingRecordInfoFail() {

    }


    function submitForm() {
        if (initFormNumber()) {
            var s = 'http://' + serverIP + '/OdBlastInspectionOperation/saveOdBlastInspectionProcess.action';
            var imgUrl = "";
            $('.imgBox  .temp-container img').each(function() {
                var temp = $(this).attr("data-url");
                if (temp != undefined) {
                    imgUrl += (temp + ";");
                }
            });
            api.ajax({
                url: s,
                method: 'post',
                timeout: 30,
                dataType: 'json',
                data: {
                    values: {
                        id: $('.id').val(),
                        pipe_no: g_pipeno,
                        mill_no: g_millno,
                        operator_no: g_employeeno,
                        air_temp: $('input[name="air_temp"]').val(),
                        blast_finish_sa25: $('#bfs').val(),
                        surface_dust_rating: $('#sdr').val(),
                        relative_humidity: $('input[name="relative_humidity"]').val(),
                        dew_point: $('input[name="dew_point"]').val(),
                        pipe_temp: $('input[name="pipe_temp_after_blast"]').val(),
                        profile: $('input[name="profile"]').val(),
                        surface_condition: $('.form-steel-select-val').text(),
                        oil_water_in_air_compressor: $('#oilwater').val(),
                        // elapsed_time:$('input[name="elapsed_time"]').val(),
                        salt_contamination_after_blasting: $('input[name="salt_contamination_after_blasting"]').val(),
                        result: $('#result').val(),
                        upload_files: imgUrl,
                        remark: $('#remark').val(),
                    }
                }
            }, function(ret, err) { //alert(ret);
                if (ret) {
                    api.alert({
                        msg: ret.message
                    });
                    if (ret.success) {
                        closeWindow();
                    }
                } else {
                    api.alert({
                        msg: JSON.stringify(err)
                    });
                }
            });
        }
    }

    //设置 钢管温度与露点温度差
    function setDeltaTemp() {
        if ($('.dew_point').val() != undefined && $('.dew_point').val() != "" && $('.dew_point').val() != "-99" && $('.pipe_temp_after_blast').val() != undefined && $('.pipe_temp_after_blast').val() != "" && $('.pipe_temp_after_blast').val() !=
            "-99") {
            var dew_point = $('.dew_point').val().replace('°C', '');
            var pipe_temp = $('.pipe_temp_after_blast').val().replace('°C', '');
            var delta = parseFloat(pipe_temp) - parseFloat(dew_point);
            $('.delta_temp').val(delta);
            validateSingleValue($('.delta_temp'));
            // var minVal = $('.delta_temp').attr('data-min');
            // var maxVal = $('.delta_temp').attr('data-max');
            // var flag = true;
            // if (delta != undefined) {
            //     if (maxVal != undefined) {
            //         if (parseFloat(maxVal) < parseFloat(delta))
            //             flag = false;
            //     }
            //     if (minVal != undefined) {
            //         if (parseFloat(delta) < parseFloat(minVal))
            //             flag = false;
            //     }
            //     if (flag)
            //         $('.delta_temp').css('background', '#FFFFFF');
            //     else
            //         $('.delta_temp').css('background', '#F9A6A6');
            //}
        }

    }
</script>
