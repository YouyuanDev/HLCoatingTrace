<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>实验</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <style>
        .empty {
            text-align: center;
            padding: 120px 0;
        }

        ul,
        li {
            padding: 0px;
            margin: 0px;
            width: 100%;
            height: 40px;
        }

        ul li {
            float: left;
            list-style: none;
            border-top: 1px solid #cdcdcd;
            padding: 4px 0px;
        }
        /*ul li:last-child{
          border-top:none;
        }*/

        .list-item {
            padding: 2px;
            height: 40px;
            line-height: 40px;
            font-size: 18px;
        }

        .list-item label {
            float: left;
            padding-left: 20px;
            color: #000000;
        }

        .list-item .lsit-item-con {
            float: right;
            padding-right: 20px;
            color: #C7C7C7;
        }

        .loginout-btn {
            width: 100%;
            outline: none;
            height: 44px;
            line-height: 44px;
            text-align: center;
            font-size: 13px;
            color: #fff;
            border-radius: 4px;
            background-color: #999;
            /*margin: 20px 0 10px;*/
        }

        /*#language {
            width: 100%;
            outline: none;
            height: 40px;
        }*/
    </style>
</head>

<body>
    <div class="div-data">
        <div style="display:none;" id="userid"></div>
        <ul id="userInfo-ul">
            <li>
                <div class="list-item">
                    <label class="i18n1" name="employeeno"></label>
                    <div class="lsit-item-con" id="userno"></div>
                </div>
            </li>
            <li>
                <div class="list-item">
                    <label class="i18n1" name="pname"></label>
                    <div class="lsit-item-con" id="username"></div>
                </div>
            </li>
            <li>
                <div class="list-item">
                    <label class="i18n1" name="ppassword"></label>
                    <div class="lsit-item-con" id="userpwd"></div>
                </div>
            </li>
            <li>
                <div class="list-item">
                    <label class="i18n1" name="pidcardno"></label>
                    <div class="lsit-item-con" id="userIdNo"></div>
                </div>
            </li>
            <li>
                <div class="list-item">
                    <label class="i18n1" name="pmobile"></label>
                    <div class="lsit-item-con" id="userphone"></div>
                </div>
            </li>
            <li>
                <div class="list-item">
                    <label class="i18n1" name="psex">性别</label>
                    <div class="lsit-item-con" id="usergender"></div>
                </div>
            </li>
            <li>
                <div class="list-item">
                    <label class="i18n1" name="page">年龄</label>
                    <div class="lsit-item-con" id="userage"></div>
                </div>
            </li>
            <li>
                <div class="list-item">
                    <label class="i18n1" name="languagesetting">语言设置</label>
                    <div class="lsit-item-con" id="language"></div>
                </div>
            </li>
            <li>
                <div class="list-item">
                    <button class="loginout-btn i18n1" name="exitlogon">退出登录</button>
                </div>

            </li>

        </ul>
    </div>
</body>

</html>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="../script/common.js"></script>
<script src="../script/jquery.i18n.properties-1.0.9.js" type="text/javascript"></script>
<script src="../script/language.js" type="text/javascript"></script>
<script type="text/javascript">
    //var serverIP='192.168.0.11';
    apiready = function() {
        if (JudgeLogin()) {
            //获取账户信息
            var operator_no = $api.getStorage('operatorno');
            var s = 'http://' + serverIP + '/person/getPersonByEmployeeNo.action';
            api.ajax({
                url: s,
                method: 'post',
                timeout: 30,
                dataType: 'json',
                data: {
                    values: {
                        employeeno: operator_no,
                    }
                }
            }, function(ret, err) {
                if (ret) {
                    $('#userid').text(ret.id);
                    $('#userno').text(ret.employee_no);
                    $('#username').text(ret.pname);
                    $('#userpwd').text(ret.ppassword);
                    $('#userIdNo').text(ret.pidcard_no);
                    $('#userphone').text(ret.pmobile);
                    $('#userage').text(ret.page);
                    if (ret.psex == "M")
                        $('#usergender').text("男");
                    else if (ret.psex == "F")
                        $('#usergender').text("女");
                    var language = $api.getStorage('userLanguage');
                    if (language == "en") {
                        $('#language').text("英文");
                    } else {
                        $('#language').text("中文");
                    }
                } else {
                    api.alert("获取账户信息时出错!");
                }
            });
            $('.loginout-btn').text('退出登录');
        } else {
            api.openWin({
                name: 'login',
                url: './login.html'
            });
            $('.loginout-btn').text('登录');

        }
        modifyUserInfo();
        loginOut();
        api.addEventListener({
            name: 'SaveUserInfoEvent'
        }, function(ret, err) {
            saveUserInfo(ret.value.index, ret.value.result);
        });

        hlLanguage("../i18n/");
    };
    //修改用户信息事件
    function modifyUserInfo() {
        $('#userInfo-ul li').click(function() {
            var index = $(this).index();
            var labelName = $(this).find('label').text();
            switch (index) {
                case 0: //工号
                    break;
                case 1: //姓名
                    editUserInfo(index, $('#username').text(), labelName);
                    break;
                case 2: //密码
                    editUserInfo(index, $('#userpwd').text(), labelName);
                    break;
                case 3: //身份证号
                    editUserInfo(index, $('#userIdNo').text(), labelName);
                    break;
                case 4: //手机号
                    editUserInfo(index, $('#userphone').text(), labelName);
                    break;
                case 7: //语言
                    editUserInfo(index, $('#language').text(), labelName);
                    break;
            }
        });
    }

    function editUserInfo(index, userData, labelName) {
        api.openWin({
            name: 'userinfo',
            url: './userinfo.html',
            pageParam: {
                index: index,
                userData: userData,
                labelName: labelName
            }
        });
    }

    function loginOut() {
        $('.loginout-btn').click(function() {
           alert("这里没有调用后台logout，需要修改");
            var logintxt = $(this).text();
            if (logintxt == "登录") {
                api.openWin({
                    name: 'login',
                    url: './login.html'
                });
            } else {
                //退出登录
                //解除所有的组
                leaveAllPushGroup();

                //解除推送绑定
                unbindPush();

                var operator_no = $api.getStorage('operatorno');
                if (operator_no != undefined) {
                    $api.rmStorage('operatorno');
                }
                api.openWin({
                    name: 'login',
                    url: './login.html'
                });
            }
        });
    }

    function saveUserInfo(index, value) {
        if (index != undefined) {
            switch (index) {
                case 0: //工号
                    break;
                case 1: //姓名
                    $('#username').text(value);
                    break;
                case 2: //密码
                    $('#userpwd').text(value);
                    break;
                case 3: //身份证号
                    $('#userIdNo').text(value);
                    break;
                case 4: //手机号
                    $('#userphone').text(value);
                    break;
                case 7: //语言
                    $('#language').text(value);
                    break;
            }
        } else {
            api.alert('修改失败!');
            return;
        }
        // var operator_no=$('#userno').text();
        var id = $('#userid').text();
        var pname = $('#username').text();
        var ppassword = $('#userpwd').text();
        var pidcard_no = $('#userIdNo').text();
        var pmobile = $('#userphone').text();
        var s = 'http://' + serverIP + '/person/savePerson.action';
        api.ajax({
            url: s,
            method: 'post',
            timeout: 30,
            dataType: 'json',
            data: {
                values: {
                    id: id,
                    pname: pname,
                    ppassword: ppassword,
                    pidcard_no: pidcard_no,
                    pmobile: pmobile
                }
            }
        }, function(ret, err) {
            if (ret) {
                api.alert({
                    msg: JSON.stringify(ret.message)
                });
            } else {
                //alert("err");
                api.alert({
                    msg: JSON.stringify(err)
                });
            }

        });
    }
</script>
