<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>打印机</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/style.css" />
    <style>
        .bg-color {
            background-color: #515151;
        }

        .printer-section {
            padding: 4px;
            overflow-y: scroll;
        }

        .printer-icon {
            background-image: url('../../image/ble_32.png');
            width: 30px;
            height: 30px;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
        }

        .aui-content-padded {
            margin: 0px;
        }

        .aui-card-list.aui-card-list-color {
            background: #19AD68;
        }

        .aui-btn-primary {
            background: #19AD68;
        }
    </style>
</head>

<body class="bg-color">
    <section class="printer-section">
        <!-- <div class="aui-card-list">
            <div class="aui-card-list-header" data-address="">
                <span class="printer-icon"></span><span class="printer-mac">34:34:DE:de:43e:4d</span><span class="printer-name">pipeinfo-table</span>
            </div>
        </div>
        <div class="aui-card-list">
            <div class="aui-card-list-header" onclick="selectPrinter(this);">
                <span class="printer-icon"></span><span class="printer-mac">34:34:DE:de:43e:4d</span><span class="printer-name">pipeinfo-table</span>
            </div>
        </div> -->
    </section>
    <footer class="aui-bar aui-bar-tab" id="footer">
        <div class="aui-bar-tab-item aui-active">
            <div class="aui-btn aui-btn-primary aui-btn-block" onclick="printerImage();">连接并打印</div>
        </div>
    </footer>
</body>

</html>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script src="../../script/jquery.i18n.properties-1.0.9.js" type="text/javascript"></script>
<script src="../../script/language.js" type="text/javascript"></script>
<script type="text/javascript">
    var arrAddress = [];
    var g_imgUrl;
    var g_address;
    var ZebraAndroidPrint;
    apiready = function() {
        //注册监听搜索到蓝牙事件
        ZebraAndroidPrint = api.require('ZebraAndroidPrint');
        var data = api.pageParam;
        if (data != undefined) {
            g_imgUrl = data.imgUrl;
        }
        findPrinters();
    }
    //开始打印图片
    function printerImage() {
        connectPrinter();
    }
    //搜索蓝牙设备
    function findPrinters() {
        //DoLoadingPicture();
        ZebraAndroidPrint.findPrinters(
            function(ret, err) {
              //  ClearLoadingPicture();
                if (ret.result) {
                    var data = ret.msg;
                    for (var i = 0; i < data.length; i++) {
                        var address = data[i].address;
                        var name = data[i].name;
                        if (arrAddress.indexOf(address) == -1) {
                            arrAddress.push(address);
                            $('.printer-section').append(makePrinterTemplate(address, name));
                        }
                    }
                } else {
                    toastSuccess(ret.msg);
                }
            }
        );
    }
    //连接打印机
    function connectPrinter() {
        //DoLoadingPicture();
        if (g_address != undefined) {
            var param = {
                printerAddr:g_address
            };
            ZebraAndroidPrint.connectPrinter(param, function(ret, err) {
                if (ret.result) {
                    //连接成功之后,移除蓝牙列表,只保留连接的
                    $('.aui-card-list').each(function() {
                        var address = $(this).attr('data-address');
                        if (address != g_address) {
                            $(this).remove();
                        }
                    });
                    //连接成功打印图片
                    printImage();
                } else {
                    toastSuccess(ret.msg);//ClearLoadingPicture();
                }
            });
        } else {
            toastFail('连接打印机失败,请选中要连接的打印机!');
            //ClearLoadingPicture();
        }
    }
    //获取打印机的状态
    function getPrinterStatus() {
        //DoLoadingPicture();
        //0:准备打印!,1:打印机暂停,无法打印!,2:无法打印,因为打印头是打开的!3:打印机缺纸  4:打印机未连接! 5 获取状态时错误,未找到Mac地址! 6:其他错误
        if (g_address != undefined) {
            var param = {
                printerAddr: g_address
            };
            ZebraAndroidPrint.getPrinterStatus(param, function(ret, err) {
                if (ret) {
                    toastSuccess(ret.msg);
                } else {
                    toastSuccess(ret.msg);
                }
                //ClearLoadingPicture();
            });
        } else {
            toastFail('获取打印机状态失败,请选中要连接的打印机!');
            //ClearLoadingPicture();
        }
    }
    //打印图片
    function printImage() {
        if (g_imgUrl != undefined) {
            var param = {
                imageUrl: g_imgUrl,
                x: 0,
                y: 0,
                width: 550,
                height: 412
            };
            ZebraAndroidPrint.printImage(param, function(ret, err) {
                if (ret) {
                    toastSuccess(ret.msg);
                    closePrinter();
                    //ClearLoadingPicture();
                    api.closeFrame({
                        name: 'printer'
                    });
                } else {
                    toastSuccess(ret.msg);//ClearLoadingPicture();
                }

            });
        } else {
            toastFail('未找到图片!');
            //ClearLoadingPicture();
        }

    }
    //关闭打印机
    function closePrinter() {
        if (g_address != undefined) {
            var param = {
                printerAddr: g_address
            };
            ZebraAndroidPrint.closePrinter(param, function(ret, err) {
                if (ret) {
                    alert(ret.msg);
                } else {
                    alert(ret.msg);
                }
            });
        } else {
            toastFail('为找到要关闭的打印机!');
        }
    }

    //选中打印机
    function selectPrinter(obj) {
        var $obj = $(obj);
        $obj.siblings().removeClass('aui-card-list-color');
        $obj.addClass('aui-card-list-color');
        var address = $obj.attr('data-address');
        if (address != undefined) {
            g_address = address;
        }
    }
    //蓝牙列表模板
    function makePrinterTemplate(address, name) {
        var template = "";
        if (address != undefined) {
            if (name == undefined)
                name = "";
            template = '<div class="aui-card-list" data-address="' + address + '" onclick="selectPrinter(this);">' +
                '<div class="aui-card-list-header">' +
                '<span class="printer-icon"></span><span class="printer-mac">' + address + '</span><span class="printer-name">' + name + '</span>' +
                '</div>' +
                '</div>';
        }
        return template;
    }

</script>
