<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>涂层生产信息</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/style.css" />
    <style>
        html,
        body {
            height: 100%;
            background-color: #f4f5f6;
        }

        .process-button {
            background-color: #19AD68;
            width: 200px;
            height: 43px;
            text-align: center;
            line-height: 43px;
            color: #ffffff;
            margin-right: 2px;
        }

        .foot-container .process-button:last-child {
            margin-right: 0px;
        }

        .loadmore-btn {
            background-color: #f2f2f2;
            color: #4682B4;
            height: 43px;
            text-align: center;
            line-height: 43px;
            width: 95%;
            margin: 0 auto;
            outline: none;
        }

        .pipeinfo-table tr td:nth-child(even) {
            text-align: center;
        }

        .qr-canvas {
            float: left;
            text-align: center;
            width: auto;
            height: auto;
            margin-left: 24px;
            margin-top: 20px;
        }

        .qr-canvas:nth-child(1),
        .qr-canvas:nth-child(4) {
            margin-left: 15px;
        }

        .qr-canvas-text {
            font-size: 1.4rem;
        }
    </style>
</head>

<body>
    <div id="main" style="overflow-y:scroll;-webkit-overflow-scrolling:touch;width:95%;margin:0 auto;padding-top:1rem;">
        <div style="width:100%;height:auto;overflow-x: hidden;">
            <table class="pipeinfo-table">
                <thead>
                    <tr>
                        <th class="i18n1" name="pipebasicinfo" colspan="4" style="text-align:center;">钢管基础信息</th>
                    </tr>
                </thead>
                <tr>
                    <td class="i18n1" name="pipeno"></td>
                    <td class="pipe_no"></td>
                    <td class="i18n1" name="statusname"></td>
                    <td class="status_name"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="od"></td>
                    <td class="od"></td>
                    <td class="i18n1" name="wt"></td>
                    <td class="wt"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="length"></td>
                    <td class="p_length"></td>
                    <td class="i18n1" name="weight"></td>
                    <td class="weight"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="grade"></td>
                    <td class="grade"></td>
                    <td class="i18n1" name="heatno"></td>
                    <td class="heat_no"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="externalcoating"></td>
                    <td class="external_coating"></td>
                    <td class="i18n1" name="internalcoating"></td>
                    <td class="internal_coating"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="projectno"></td>
                    <td class="project_no"></td>
                    <td class="i18n1" name="projectname"></td>
                    <td class="project_name"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="contractno"></td>
                    <td class="contract_no"></td>
                    <td class="i18n1" name="pipemakinglotno"></td>
                    <td class="pipe_making_lot_no"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="centerlinecolor"></td>
                    <td class="center_line_color"></td>
                    <td class="i18n1" name="pipeendcolor"></td>
                    <td class="pipe_end_color"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="rebevelmark"></td>
                    <td class="rebevel_mark"></td>
                    <td class="i18n1" name="clientspec"></td>
                    <td class="client_spec"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="odsamplingmark"></td>
                    <td class="odsampling_mark"></td>
                    <td class="i18n1" name="idsamplingmark"></td>
                    <td class="idsampling_mark"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="oddscsamplemark"></td>
                    <td class="od_dsc_sample_mark"></td>
                    <td class="i18n1" name="odpesamplemark"></td>
                    <td class="od_pe_sample_mark"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="idglasssamplemark"></td>
                    <td class="id_glass_sample_mark"></td>
                    <td class="i18n1" name="shipmentdate"></td>
                    <td class="shipment_date"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="odcoatingdate"></td>
                    <td class="od_coating_date"></td>
                    <td class="i18n1" name="idcoatingdate"></td>
                    <td class="id_coating_date"></td>
                </tr>
                <tr>
                    <td class="i18n1" name="acceptancecriteria"></td>
                    <td class="acceptance_criteria_no"></td>
                    <td >
                    <div class="loadmore-btn i18n1" name="loadacinfo" onclick="loadACInfo()">工艺卡信息</div>
                    </td>
                </tr>

            </table>
        </div>
        <div id="qrdiv" style="width:100%;height:auto;margin-top:20px;overflow-x:scroll;" onclick="rquestPrintCount()">
            <div style="margin:0px auto;text-align:center;" id="qrcodeCanvas"></div>
            <div style="margin:0px auto;text-align:center;font-size: 14px" id="qrcodeText"></div>
        </div>
        <div id="qr-container" style="width:100%;height:0;position:relative;padding-bottom:50%">
            <div class="qr-canvas">
                <div class="qr-canvas-inner"></div>
                <div class="qr-canvas-text"></div>
            </div>
            <div class="qr-canvas">
                <div class="qr-canvas-inner"></div>
                <div class="qr-canvas-text"></div>
            </div>
            <div class="qr-canvas">
                <div class="qr-canvas-inner"></div>
                <div class="qr-canvas-text"></div>
            </div>
            <div class="clearfix"></div>
        </div>
        <div class="loadmore-div" style="height:auto;margin-top:20px;font-size: 16px;color:#000000;font-family:" Sans-serif ";">
            <div class="loadmore-btn i18n1" name="loadmorninfo" onclick="loadMoreInfo()">更多生产信息...</div>
        </div>
        <div id="pipe-process-info" style="width:100%;height:auto;margin:0 auto;overflow-x: hidden;">

        </div>
    </div>

</body>

</html>

<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script src="../../script/jquery.i18n.properties-1.0.9.js" type="text/javascript"></script>
<script src="../../script/language.js" type="text/javascript"></script>
<script type="text/javascript" src="../../script/jquery.qrcode.js"></script>
<script type="text/javascript" src="../../script/qrcode.js"></script>
<script type="text/javascript" src="../../script/utf.js"></script>
<script type="text/javascript" src="../../script/html2canvas.min.js"></script>
<script type="text/javascript">
    var pipeno;
    var showmore = false;
    var g_result_input_output;
    apiready = function() {
            LoadProcess_input_output();
            var data = api.pageParam;
            pipeno = data.pipeno;
            //下拉刷新，钢管信息
            dropdownLoading();
            registerPrintImageListener();
            //如果钢管编号不为空，搜索钢管信息
            if (pipeno != undefined) {
                SearchpipeInfo();
            } else {
                toastFail("查询出现异常!");
                return;
            }
        }
        //查看图片事件
    function setBrowsePicutre(obj) {
        var picturelistStr = $(obj).attr('data-list');
        if (picturelistStr != undefined && picturelistStr.length > 0) {
            var picturelist = picturelistStr.split(";");
            if (picturelist.length > 0) {
                var picturelistArr = [];
                var url = "http://" + serverIP + "/upload/pictures/";
                for (var i = 0; i < picturelist.length; i++) {
                    if (picturelist[i] != undefined && picturelist[i].trim().length > 0)
                        picturelistArr.push(url + picturelist[i]);
                }
                var imageBrowser = api.require('imageBrowser');
                imageBrowser.openImages({
                    showList: true,
                    imageUrls: picturelistArr
                });
            } else {
                toastFail("暂无图片!");
            }
        } else {
            toastFail("暂无图片!");
        }
    }

    // 查询钢管详细信息
    function SearchpipeInfo() {
        var s = 'http://' + serverIP + '/APPRequestTransfer/getCoatingInfoByPipeNo.action';
        api.ajax({
            url: s,
            method: 'post',
            timeout: 30,
            dataType: 'json',
            data: {
                values: {
                    pipe_no: pipeno
                }
            }
        }, function(ret, err) {
            api.hideProgress();
            if (ret) {
                if (ret.success == false) {
                    toastFail(ret.message);
                } else {
                    pipeinfo = ret.pipeinfo;
                    urloptions = ret.urloptions;
                    //显示钢管基础信息
                    showPipeBasicInfo(pipeinfo);
                    //显示下一工序选项，通知pipeinforoot.html刷新 选项按钮
                    var jsfun = 'showNextProcessOptions(' + JSON.stringify(ret.urloptions) + ');';
                    api.execScript({
                        name: 'pipeinforoot',
                        script: jsfun
                    });
                    //若已经显示了所有工序信息，则刷新
                    if (showmore) {
                        loadMoreInfo();
                    }
                    hlLanguage("../../i18n/");
                }
            } else {
                toastFail("查询钢管详细信息时异常,网络请求状态码:"+err.statusCode+",错误码:"+err.code);
            }
        });
    }

    //下拉刷新更新钢管基础信息
    function dropdownLoading() {
        api.setRefreshHeaderInfo({
            loadingImg: 'widget://image/loading_more.png',
            bgColor: '#ccc',
            textColor: '#fff',
            textDown: '下拉刷新...',
            textUp: '松开刷新...'
        }, function(ret, err) {
            //重新刷新
            $('#qrcodeCanvas').empty();
            SearchpipeInfo();
            setTimeout(function() {
                //执行刷新
                api.refreshHeaderLoadDone();
            }, 50);
        });
    }

    //显示钢管基础信息
    function showPipeBasicInfo(pipeinfo) {
        $('.contract_no').text(pipeinfo.contract_no);
        $('.status_name').text(pipeinfo.status_name);
        $('.weight').text(pipeinfo.weight);
        $('.client_spec').text(pipeinfo.client_spec);
        $('.project_name').text(pipeinfo.project_name);
        $('.pipe_no').text(pipeinfo.pipe_no);
        $('.project_no').text(pipeinfo.project_no);
        $('.p_length').text(pipeinfo.p_length);
        $('.external_coating').text(pipeinfo.external_coating);
        $('.od').text(pipeinfo.od);
        $('.grade').text(pipeinfo.grade);
        $('.wt').text(pipeinfo.wt);
        $('.pipe_making_lot_no').text(pipeinfo.pipe_making_lot_no);
        $('.heat_no').text(pipeinfo.heat_no);
        $('.internal_coating').text(pipeinfo.internal_coating);
        $('.center_line_color').text(pipeinfo.center_line_color);
        $('.pipe_end_color').text(pipeinfo.pipe_end_color);
        $('.rebevel_mark').text(pipeinfo.rebevel_mark);
        $('.odsampling_mark').text(pipeinfo.odsampling_mark);
        $('.idsampling_mark').text(pipeinfo.idsampling_mark);
        $('.od_dsc_sample_mark').text(pipeinfo.od_dsc_sample_mark);
        $('.od_pe_sample_mark').text(pipeinfo.od_pe_sample_mark);
        $('.id_glass_sample_mark').text(pipeinfo.id_glass_sample_mark);
        $('.shipment_date').text(formatterdate(pipeinfo.shipment_date));
        $('.od_coating_date').text(formatterdate(pipeinfo.od_coating_date));
        $('.id_coating_date').text(formatterdate(pipeinfo.id_coating_date));
        $('.acceptance_criteria_no').text(pipeinfo.acceptance_criteria_no);
        //QRCode
        GenerateQRCode(pipeinfo.pipe_no);
    }

    //查看检验标准列表
    function loadACInfo() {
      //$('.acceptance_criteria_no').text('13');
      var acceptance_criteria_no=$('.acceptance_criteria_no').text();
      alert(acceptance_criteria_no);
      //加载工艺卡标准的页面 acceptancecriteriadetail.html

    }




    //更多生产信息
    function loadMoreInfo() {
        showmore = true;
        //清空moreinfo
        $('#pipe-process-info').empty();
        var s = 'http://' + serverIP + '/pipeinfo/searchPipeRecord.action';
        api.ajax({
            url: s,
            method: 'post',
            timeout: 30,
            dataType: 'json',
            data: {
                values: {
                    pipe_no: pipeno
                }
            }
        }, function(ret, err) {
            if (ret) {
                var data = ret;
                var flag = false;
                var language = getCookie("userLanguage");
                if (data.length > 0)
                    flag = true;
                for (var i = 0; i < data.length; i++) {
                    for (var key in data[i]) {
                        if (key.indexOf('header') == -1) {
                            getTemplate(key, data[i][key], language, data[i][key + "_header"]);
                        }
                    }
                }
                if (!flag) {
                    toastSuccess('暂无更多内容');
                } else {
                    $('.loadmore-div').remove();
                }
                hlLanguage("../../i18n/");
            } else {
                toastFail("查询更多生产信息时异常,网络请求状态码:"+err.statusCode+",错误码:"+err.code);
            }
        });

    }
    //生成有关钢管的记录模板
    function getTemplate(process_code, array, language, header_dict) {
        var template = "";
        template += '<table  title="" class="dataintable"><thead><tr><th class="i18n1" name="' + process_code + '" colspan="6">' + process_code + '</th></tr></thead><tbody>';
        var remark = "",
            result = "",
            result_name = "",
            uploadfiles = "";

        for (var i = 0; i < array.length; i++) {
            template += '<tr>';
            var dict = header_dict;
            remark = dict.remark;
            result = dict.result;
            uploadfiles = dict.upload_files;
            for (var t = 0; t < g_result_input_output.length; t++) {
                if (g_result_input_output[t].process_code == process_code) {
                    for (var w = 0; w < g_result_input_output[t].output.length; w++) {
                        if (g_result_input_output[t].output[w].result == result) {
                            if (language == "en") {
                                result_name = g_result_input_output[t].output[w].result_name_en;
                            } else {
                                result_name = g_result_input_output[t].output[w].result_name;
                            }
                        }
                    }
                }
            }
            var max_value = array[i].max_value;
            var min_value = array[i].min_value;
            var item_value = array[i].item_value == undefined ? "" : array[i].item_value;
            var range = "";
            var flag = false;
            if (max_value != undefined && min_value != undefined) {
                if (array[i].need_verify != undefined && array[i].need_verify == "1") {
                    range = "(" + min_value + "~" + max_value + ")";
                    if (item_value != undefined && !isNaN(item_value)) {
                        if (parseFloat(max_value) < parseFloat(item_value))
                            flag = true;
                        if (parseFloat(min_value) > parseFloat(item_value))
                            flag = true;
                    }
                }
            }
            if (language && language == "en") {
                var unit = (array[i].unit_name_en == undefined || array[i].unit_name_en == "") ? "" : ' (' + array[i].unit_name_en + ') ';
                template += ' <td>' + array[i].item_name_en + unit + range + '</td>';
            } else {
                var unit = (array[i].unit_name == undefined || array[i].unit_name_en == "") ? "" : ' (' + array[i].unit_name + ') ';
                template += ' <td>' + array[i].item_name + unit + range + '</td>';
            }
            if (flag) {
                template += '<td>' + item_value + '</td>';
            } else {
                template += '<td>' + item_value + '</td>';
            }
            template += '</tr>';
        }
        template += '<tr>';
        template += ' <td class="i18n1" name="result">结果</td>';
        template += ' <td>' + result_name + '</td>';
        template += '</tr>';
        //图片
        template += '<tr>';
        template += '<td class="i18n1" name="viewpicture">查看图片</td>';
        if (uploadfiles != undefined && uploadfiles != "") {
            template += '<td style="width:50%;text-align:center;padding:5px 0px;" class="pipeinfo-td" ><div style="color:#87CEEB;" onclick="setBrowsePicutre(this);" data-list="' + uploadfiles +
                '" class="upload-pictures i18n1" name="viewpicture">图片</div></td>';
        } else {
            template += '<td style="width:50%;text-align:center;padding:5px 0px;" class="pipeinfo-td" ><div style="color:#87CEEB;" class="upload-pictures i18n1" name="nopictures">无图片</div></td>';

        }
        template += '</tr>';
        template += '<tr>';
        template += ' <td class="i18n1" name="remark">备注</td>';
        template += ' <td>' + remark + '</td>';
        template += '</tr></tbody></table>';
        $('#pipe-process-info').append(template);
    }
    //生成二维码
    function GenerateQRCode(pipeno) {
        //生成显示的一张二维码
        jQuery('#qrcodeCanvas').qrcode({
            render: "canvas",
            text: pipeno,
            width: "100", //二维码的宽度
            height: "100", //二维码的高度
            background: "#ffffff", //二维码的后景色
            foreground: "#000000", //二维码的前景色
            ecLevel: 'H'           //识别度  'L', 'M', 'Q' or 'H'
            //src: '../../image/logo2.jpg' //二维码中间的图片
        });
        $('#qrcodeText').text(pipeno);
        //生成用于打印的3张二维码
        $('.qr-canvas-inner').empty();
        //二维码的宽度
        var width = api.winWidth / 3 - 35;
        $('#qr-container').hide();
        jQuery('.qr-canvas-inner').qrcode({
            render: "canvas",
            text: pipeno,
            width: width, //二维码的宽度
            height: width, //二维码的高度
            background: "#ffffff", //二维码的后景色
            foreground: "#000000", //二维码的前景色
            ecLevel: 'H'    //识别度  'L', 'M', 'Q' or 'H'
            //src: '../../image/logo2.jpg' //二维码中间的图片
        });

        // var os_type = api.systemType;
        // if (os_type == "ios") {
        //     $('.qr-canvas-text').css('font-size', '1.4rem');
        // } else if (os_type == "android") {
        //     $('.qr-canvas-text').css('font-size', '1.4rem');
        // }
        $('.qr-canvas-text').text(pipeno);
        //调整二维码标签图片的整体高度，需要按照长度高度比例设置高度  2:1，以下为临时测试
        //var w=$('#qr-container').css('width');
        //var h=$('#qr-container').css('height');
        //alert("before w="+w+" h="+h);
        //var new_height=parseInt(w)/2+'px';
         // $('#qr-container').css('width', '1062px');
      //  $('#qr-container').css('height', new_height);
        //w=$('#qr-container').css('width');
        //h=$('#qr-container').css('height');
        //alert("after w="+w+" h="+h);
    }

    function printQRCode(count) {
        var msg = "此管号已打印" + count + "次,是否再次打印?"
        api.confirm({
            title: '提示',
            msg: msg,
            buttons: ['确定', '取消']
        }, function(ret, err) {
            if (ret.buttonIndex == 1) {
                DoLoadingPicture();
                $('#qr-container').show();
                setTimeout(function() {
                    html2canvas(document.querySelector("#qr-container")).then(function(canvas) {
                        var canvas = canvas.toDataURL("image/png");
                        var img = canvas.replace('data:image/png;base64,', '');
                        var trans = api.require('trans');
                        var date = new Date();
                        var imgName = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDay() + "-" + date.getHours() + "-" + date.getMinutes() + "-" + date.getSeconds() + "-" + date.getMilliseconds() + ".png";
                        trans.saveImage({
                            base64Str: img,
                            album: true,
                            imgPath: "fs://jietu/",
                            imgName: imgName
                        }, function(ret, err) {
                            $('#qr-container').hide();
                            if (ret.status) {
                                var imgPath = "fs://jietu/" + imgName;
                                toastSuccess('图片已生成,保存本地成功!');
                                openZebraPrinter(imgPath);
                            } else {
                                toastFail('图片生成失败!');
                            }
                        });
                        ClearLoadingPicture();
                    });
                }, 1000);
            }
        });
    }
    //加载工序结论集合
    function LoadProcess_input_output() {
        var s = 'http://' + serverIP + '/data/process_input_output.json';
        api.ajax({
            url: s,
            method: 'post',
            timeout: 30,
            dataType: 'json'
        }, function(ret, err) {
            if (ret) {
                g_result_input_output = ret;
            }
        });
    }

    //调用打印app
    function openZebraPrinter(imgPath) {
        var sType = api.systemType;
        if (sType == "ios") {
            toastSuccess('ios暂不支持打印!');
        } else if (sType == "android") {
            //Android中的使用方法如下：
            // api.openApp({
            //     androidPkg: 'com.zebra.android.zebrautilities'
            // }, function(ret, err) {
            //
            // });
            api.openFrame({
                name: 'printer',
                url: '../addition/printer.html',
                rect: {
                    x: 20,
                    y: 100,
                    w: api.winWidth - 40,
                    h: api.winHeight - 200
                },
                pageParam: {
                    imgUrl: imgPath
                },
                reload: true
            });
        }
    }
    //监听打印机打印成功事件
    function registerPrintImageListener() {
        api.addEventListener({
            name: 'printImageEvent'
        }, function(ret, err) {
            var result = ret.value.result;
            if (result) {
                addPrintRecord();
            }
        });
    }
    //获取该钢管打印的次数
    function rquestPrintCount() {
        var s = 'http://' + serverIP + '/QrCodeOperation/APPGetQRCodePrintTimes.action';
        api.ajax({
            url: s,
            method: 'post',
            timeout: 30,
            dataType: 'json',
            data: {
                values: {
                    pipe_no: pipeno
                }
            }
        }, function(ret, err) {
            if (ret) {
                if (ret.success) {
                    printQRCode(ret.count);
                } else {
                    toastFail(ret.message);
                }
            } else {
                toastFail("获取打印次数时失败!");
            }
        });
    }
    //添加打印次数
    function addPrintRecord() {
        var s = 'http://' + serverIP + '/QrCodeOperation/APPPrintQRCode.action';
        api.ajax({
            url: s,
            method: 'post',
            timeout: 30,
            dataType: 'json',
            data: {
                values: {
                    pipe_no: pipeno
                }
            }
        }, function(ret, err) {

        });
    }
</script>
